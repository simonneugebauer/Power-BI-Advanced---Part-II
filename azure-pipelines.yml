# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none

parameters:
- name: organization
  type: string
  default: 'qunisgmbh'
- name: project
  type: string
  default: 'QUNIS - Academy'
- name: repository
  type: string
  default: 'QUNIS - Academy'
- name: sourceBranch
  type: string
  default: 'main'
- name: targetBranch
  type: string
  default: 'QUNIS_Development'


pool:
  vmImage: 'windows-latest'

steps:
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    errorActionPreference: 'continue'
    failOnStderr: false
    script: |
      $ErrorActionPreference = "Continue"
      $VerbosePreference = "Continue"
      
      try {
        $organization = "$(organization)"
        $project = "$(project)"
        $repository = "$(repository)"
        $sourceBranch = "$(sourceBranch)"
        $targetBranch = "$(targetBranch)"
        
        Write-Verbose "Organization: $organization"
        Write-Verbose "Project: $project"
        Write-Verbose "Repository: $repository"
        Write-Verbose "Source Branch: $sourceBranch"
        Write-Verbose "Target Branch: $targetBranch"
        
        # Check execution policy
        $executionPolicy = Get-ExecutionPolicy
        Write-Verbose "Current Execution Policy: $executionPolicy"
        
        # Install required modules
        Write-Verbose "Installing ImportExcel module..."
        Install-Module -Name ImportExcel -Force -Scope CurrentUser -ErrorAction Stop
        Import-Module ImportExcel -ErrorAction Stop
        Write-Verbose "ImportExcel module installed and imported successfully."
        
        # Authenticate with Azure DevOps
        $token = "$(System.AccessToken)"
        $base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(":$($token)"))
        
        # Get the list of changed files
        $orgUrl = "https://dev.azure.com/$organization"
        $url = "$orgUrl/$project/_apis/git/repositories/$repository/diffs/commits?baseVersion=$sourceBranch&targetVersion=$targetBranch&api-version=6.0"
        Write-Verbose "Fetching changed files from: $url"
        $response = Invoke-RestMethod -Uri $url -Headers @{Authorization=("Basic {0}" -f $base64AuthInfo)} -Method GET -ErrorAction Stop
        
        $changedFiles = $response.changes | Where-Object { $_.changeType -ne "Delete" } | Select-Object -ExpandProperty item
        Write-Verbose "Number of changed files: $($changedFiles.Count)"
        
        # Create an Excel workbook
        $excelPackage = New-Object OfficeOpenXml.ExcelPackage
        $worksheet = $excelPackage.Workbook.Worksheets.Add("Changes")
        
        $row = 1
        foreach ($file in $changedFiles) {
            Write-Verbose "Processing file: $($file.path)"
            # Get file content for both branches
            $sourceUrl = "$orgUrl/$project/_apis/git/repositories/$repository/items?path=$($file.path)&versionDescriptor.version=$sourceBranch&api-version=6.0"
            $targetUrl = "$orgUrl/$project/_apis/git/repositories/$repository/items?path=$($file.path)&versionDescriptor.version=$targetBranch&api-version=6.0"
            
            $sourceContent = Invoke-RestMethod -Uri $sourceUrl -Headers @{Authorization=("Basic {0}" -f $base64AuthInfo)} -Method GET -ErrorAction Stop
            $targetContent = Invoke-RestMethod -Uri $targetUrl -Headers @{Authorization=("Basic {0}" -f $base64AuthInfo)} -Method GET -ErrorAction Stop
            
            # Compare content
            $sourceLines = $sourceContent -split "`n"
            $targetLines = $targetContent -split "`n"
            
            $worksheet.Cells[$row, 1].Value = "File: $($file.path)"
            $worksheet.Cells[$row, 1, $row, 4].Merge = $true
            $row++
            
            $worksheet.Cells[$row, 1].Value = "Source ($sourceBranch)"
            $worksheet.Cells[$row, 3].Value = "Target ($targetBranch)"
            $row++
            
            $maxLines = [Math]::Max($sourceLines.Count, $targetLines.Count)
            for ($i = 0; $i -lt $maxLines; $i++) {
                $worksheet.Cells[$row, 1].Value = $i + 1
                $worksheet.Cells[$row, 2].Value = $sourceLines[$i]
                $worksheet.Cells[$row, 3].Value = $i + 1
                $worksheet.Cells[$row, 4].Value = $targetLines[$i]
                
                if ($sourceLines[$i] -ne $targetLines[$i]) {
                    $worksheet.Cells[$row, 1, $row, 2].Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
                    $worksheet.Cells[$row, 1, $row, 2].Style.Fill.BackgroundColor.SetColor([System.Drawing.Color]::LightPink)
                    $worksheet.Cells[$row, 3, $row, 4].Style.Fill.PatternType = [OfficeOpenXml.Style.ExcelFillStyle]::Solid
                    $worksheet.Cells[$row, 3, $row, 4].Style.Fill.BackgroundColor.SetColor([System.Drawing.Color]::LightGreen)
                }
                
                $row++
            }
            
            $row += 2  # Add space between files
        }
        
        # Save the Excel file
        $excelPath = "$(Build.ArtifactStagingDirectory)\BranchCompare.xlsx"
        $excelPackage.SaveAs($excelPath)
        
        Write-Host "Excel file saved to: $excelPath"
      }
      catch {
        Write-Error "An error occurred: $_"
        Write-Error "Stack Trace: $($_.ScriptStackTrace)"
        exit 1
      }
      finally {
        if ($null -ne $excelPackage) {
          $excelPackage.Dispose()
        }
      }
      
      exit $LASTEXITCODE

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'BranchCompare'
  condition: succeededOrFailed()